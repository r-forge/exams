\ProvidesPackage{beamerthemerexams}
\def\fileversion{0.2}
\def\filename{beamerthemerexams}
\def\filedate{2017/09/14}
%% License: GPL-2 | GPL-3
%% Copyright: (C) 2017 Reto Stauffer, Achim Zeileis
%% Please report errors to: Achim.Zeileis@R-project.org

%% Setting images path
\graphicspath{{_images/}{./}}

%% define options: foot, noslidenumber, logo, license, licenseall, sectionintroframe,
%% nototalframenumber, titleoutline, nosectiontitlepage

%% foot adds a foot line to the frames including conference and date
\newif\iffooter
\footerfalse
\DeclareOption{foot}{
  \footertrue
}

%% noslidenumber removes the slide number
\newif\ifsn
\sntrue
\DeclareOption{noslidenumber}{
  \snfalse
  \footerfalse
}

%% logo adds the university logo on the left of the footer line
\newif\ifframelogo
\framelogofalse
\DeclareOption{logo}{
  \framelogotrue
}

%% license adds a creative common license (CC-BY) symbol to the title slide
\newif\iflicense
\licensefalse
\DeclareOption{license}{
  \licensetrue
}

%% licenseall adds a creative common license (CC-BY) symbol to all other slides
\newif\iflicenseall
\licenseallfalse
\DeclareOption{licenseall}{
  \licensealltrue
}

%% sectionintroframe adds an empty frame before each new section with the title of the section
% intended for long talks;
\newif\ifsectionintroframe
\sectionintroframefalse
\DeclareOption{sectionintroframe}{
  \sectionintroframetrue
}

%% nototalframenumber suppresses the display of the totalframenumber in the lower right
%% (e.g., '2' instead of '2/27')
\newif\ifnototalframenumber
\nototalframenumberfalse
\DeclareOption{nototalframenumber}{
  \nototalframenumbertrue
}

%% titleoutline adds a slight black border around the font in the titlepage, because white text on
%% light blue background is hard to read on bad projectors/bright rooms
%% THIS BREAKS OUT OF THE CORPORATE DESIGN!
\newif\iftitleoutline
\titleoutlinefalse
\DeclareOption{titleoutline}{
  \titleoutlinetrue
}

%% nosectiontitlepage switches off the behaviour of inserting the titlepage every time a \section is called
% this makes it possible to use more than one section + thanks page and a ToC
% off by default
\newif\ifnosectiontitlepage
\nosectiontitlepagefalse
\DeclareOption{nosectiontitlepage}{
    \nosectiontitlepagetrue
}

%% default options
\ExecuteOptions{}

%% to activate the options:
\ProcessOptions

%% fonts
\RequirePackage[T1]{fontenc}
\RequirePackage[default]{lato}
\usefonttheme{structurebold}
\setbeamerfont{frametitle}{size*={16pt}{16pt},series=\mdseries}
\setbeamerfont{framesubtitle}{size*={12pt}{12pt},series=\mdseries}
\setbeamerfont{title}{size*={16pt}{18pt},series=\mdseries}
\setbeamerfont{author}{size*={13.5pt}{14pt},series=\mdseries}
\setbeamerfont{url}{size*={13.5pt}{14pt},series=\mdseries}
\setbeamerfont{subtitle}{size*={10pt}{12pt},series=\mdseries}

\setbeamerfont{footline}{size*={5pt}{50pt},parent=normal text}
\newcommand\footraise{.2}


%% colors
\setbeamercolor*{normal text}{fg=rexamsdgray,bg=white}
\setbeamercolor*{title}{fg=rexamsdgray,bg=white}
\setbeamercolor*{subtitle}{fg=rexamsdgray,bg=white}
\setbeamercolor*{frametitle}{fg=rexamsmgray}
\setbeamercolor*{framesubtitle}{fg=rexamsmgray}
\setbeamercolor*{item}{fg=rexamsmgray}
\setbeamercolor*{structure}{fg=rexamsdgray,bg=white}
\setbeamercolor*{alerted text}{parent=structure}
\setbeamercolor*{verbcolor}{fg=rexamsdgreen}
\setbeamercolor*{author}{fg=rexamsmgray} % on title slide
\setbeamercolor*{url}{fg=rexamsmgray} % on title slide
\setbeamercolor*{footer}{fg=rexamsmgray}
\setbeamercolor*{section in head/foot}{parent=normal text}
\setbeamercolor*{framenumber in head/foot}{parent=normal text}

%% Latex block styling: {block}, {alertblock}, and {exampleblock}
\setbeamercolor*{block title}{fg=white,bg=rexamsdgreen}
\setbeamercolor*{block body}{fg=rexamsdgray,bg=rexamslgreen}
\setbeamercolor*{block title alerted}{fg=white,bg=rexamsdorange}
\setbeamercolor*{block body alerted}{fg=rexamsdgray,bg=rexamslorange}
\setbeamercolor*{block title example}{fg=white,bg=rexamsmgray}
\setbeamercolor*{block body example}{fg=rexamsdgray,bg=rexamslgray}

%% Code styling
\setbeamercolor*{code}{fg=rexamsdgray} % inline code


%% Setting the header image based on input 'ID'.
%% Switch/Case, Default is "1" or rexams_header1.jpg.
\usepackage{xstring}
\newcommand{\headerimage}[1]{%
   \IfStrEqCase{#1}{%
      {4}{%
         \gdef\myheaderimageid{#1}%
         \gdef\myheaderimageposition{ne}%
         \gdef\myheaderimage{rexams_header4.jpg}%
      }{3}{%
         \gdef\myheaderimageid{#1}%
         \gdef\myheaderimageposition{ne}%
         \gdef\myheaderimage{rexams_header3.jpg}%
      }{2}{%
         \gdef\myheaderimageid{#1}%
         \gdef\myheaderimageposition{ne}%
         \gdef\myheaderimage{rexams_header2.jpg}%
      }}[%
         \gdef\myheaderimageid{1}%
         \gdef\myheaderimageposition{nw}%
         \gdef\myheaderimage{rexams_header1.jpg}%
      ]%
}


%% Using different logos for footer and title. Logo on title
%% slides can be replaced by a version with wordmark while the
%% footer should always show the version without wordmark.
\newcommand{\footerlogoimage}[1]{\gdef\myfooterlogoimage{#1}}
\newcommand{\logoimage}[1]{\gdef\mylogoimage{#1}}


%% inner theme
%% itemize symbols
\setbeamertemplate{items}[circle]

%% custom beamer button
\setbeamertemplate{button}{\tikz
  \node[
  inner xsep=3pt,
  draw=rexamsdgreen,
  fill=rexamsdgreen,
  rounded corners=0pt]  {\mathstrut\insertbuttontext\mathstrut};}

%% frametitle (header)
\defbeamertemplate*{frametitle}{rexams}
{
   {\usebeamerfont{frametitle}\rule[-.4em]{0pt}{10mm}\insertframetitle\par}%
   \ifx\insertframesubtitle\@empty%
   \else%
      {\usebeamerfont{framesubtitle}\rule[-1.3em]{0pt}{9mm}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\par}%
   \fi

}


%% Helper function to show the subtitle if set
\makeatletter
\newcommand\showsubtitle[1]{%
  \edef\w@test{#1}      % Makro, dessen Inhalt gleich #1 ist
  \ifx\w@test\@empty    % Anweisungen, falls #1 unbesetzt ist nichts machen
  \else                 % Anweisungen, falls #1 nicht unbesetzt ist
    \\[0mm]
    \usebeamercolor[fg]{subtitle}
    \fontsize{10}{10}{\selectfont#1}
  \fi}
\makeatother

%% Helper function to show URL if specified
\makeatletter
\newcommand\showurl[1]{%
   \edef\w@test{#1}      % Makro, dessen Inhalt gleich #1 ist
   \ifx\w@test\@empty % Anweisungen, falls #1 unbesetzt ist nichts machen
      % do nothing
   \else        % Anweisungen, falls #1 nicht unbesetzt ist
      {\usebeamerfont{url}\vspace{.3em}\usebeamercolor[fg]{url}\\ \url{\myURL}}
   \fi}
\makeatother

%% outer theme
\setbeamersize{text margin left=10mm,text margin right=10mm}

% foot line
\setbeamertemplate{footline}{

\iffooter
   \begin{beamercolorbox}[wd=\paperwidth,dp=1.3mm]{title in head/foot}
     \usebeamercolor[fg]{titleline}
     \hspace{5mm}\hrulefill\vspace{0.8mm}\hspace{5mm} % offsync like in the corporate design manual

     \usebeamercolor[fg]{structure}
     \ifframelogo
        % Different spacing as the image comes with white margins
        \hspace{5.8mm}{\includegraphics[width=15mm]{\myfooterlogoimage}}\hspace{1mm}
     \else
        \hspace{10mm}
         {\rule[0em]{0pt}{4.5mm}}%
     \fi
     \raisebox{\footraise\height}{{\usebeamerfont{footline}\myfootertext~\insertdate}}
     \ifnototalframenumber
       \hfill \raisebox{\footraise\height}{{\usebeamerfont{footline} \selectfont\insertframenumber}}
     \else
       \hfill \raisebox{\footraise\height}{{\usebeamerfont{footline} \selectfont\insertframenumber/\inserttotalframenumber}}
     \fi
     \iflicenseall
        \raisebox{.15\height}{\hspace{1mm}\includegraphics[width=5mm]{license_ccby}\hspace{10mm}}
     \else
        \hspace{10mm}
     \fi
   \end{beamercolorbox}
\else
   \ifsn
      \begin{beamercolorbox}[wd=\paperwidth,dp=0.2cm]{title in head/foot}%
         \usebeamercolor[fg]{structure}
         \vspace{0.2cm}
         \ifnototalframenumber
            \hfill \insertframenumber\hspace{0.8cm}
         \else
            \hfill \insertframenumber/\inserttotalframenumber\hspace{0.8cm}
         \fi
      \end{beamercolorbox}
   \else
      \begin{beamercolorbox}[wd=\paperwidth,dp=0.2cm]{title in head/foot}%
         \usebeamercolor[fg]{structure}
         \vspace{0.2cm}
         \vspace{\baselineskip}
      \end{beamercolorbox}
   \fi
\fi
}

%% navigation symbols
\setbeamertemplate{navigation symbols}{}

%% style
\RequirePackage{colortbl}
\RequirePackage{graphicx}
%text outline for better visibility
\iftitleoutline
    \RequirePackage{pdfrender}
    \newcommand{\textoutline}[1]{\textpdfrender{TextRenderingMode=2,
                                                 LineWidth=.025ex,
                                                 StrokeColor=black,
                                                 FillColor=white}{#1}%
                                }
\fi

\renewcommand{\arraystretch}{1.2}
\RequirePackage{amsmath,amssymb}
\RequirePackage{array}

%%%% R/exams color

%% dark: #1f7a7a / RGB (0.12, 0.48, 0.48) / HCL (192.2, 33.6, 46.5)
%% light: #cafafa / RGB (0.79, 0.98, 0.98) / HCL (192.2, 25, 95)
\definecolor{rexamsdgreen}{rgb}{0.12,0.48,0.48}%
\definecolor{rexamslgreen}{rgb}{0.79,0.98,0.98}%

%% dark: #ff8000 / RGB (1, 0.5, 0) / HCL (30.1, 122.6, 67.1)
%% light: #ffe2cb / RGB (1, 0.886, 0.796) / HCL (30.1, 50, 95)
\definecolor{rexamsdorange}{rgb}{1,0.5,0}%
\definecolor{rexamslorange}{rgb}{1.00,0.90,0.76}%

%% gray: 0.23 (3b), 0.4 (66), 0.8 (cc) 
\definecolor{rexamsdgray}{rgb}{0.23,0.23,0.23}%
\definecolor{rexamsmgray}{rgb}{0.4,0.4,0.4}%
\definecolor{rexamslgray}{rgb}{0.8,0.8,0.8}%

% Fix broken symbols
% (I don't know why, but some symbols do not work correctly)
\DeclareSymbolFont{mysymbols}{OMS}{cmsy}{m}{n}
\SetSymbolFont{mysymbols}{bold}{OMS}{cmsy}{b}{n}
\DeclareMathSymbol{\myRightarrow}{\mathrel}{symbols}{"29}
\let\Rightarrow\myRightarrow

% R/Sweave
\setkeys{Gin}{width=0.8\textwidth}
\RequirePackage{fancyvrb}
\IfFileExists{upquote.sty}{\RequirePackage{upquote}}{}
\renewcommand{\ttdefault}{laett}
\DefineVerbatimEnvironment{Scode}{Verbatim}{}
\DefineVerbatimEnvironment{Sinput}{Verbatim}{formatcom=\color{rexamsdgreen}}
\DefineVerbatimEnvironment{Soutput}{Verbatim}{formatcom=\color{rexamsdgray}}
\newenvironment{Schunk}{\fontsize{9}{10}\selectfont}{}

\AtBeginLecture{%
  \section{\inserttitle}%
  \immediate\write\@auxout {\string \newlabel{lect:@@\thelecture}{{\insertframenumber}}}%
  \typeout{[LECTURE]=[\thelecture][\insertlecture][\thepage][\theframenumber]}%
}

% ------------------------------------------------------------------------
% Make section titles

% we start with section 0 (instead of default 1)
\setcounter{section}{0}
\usepackage{tikz}

%% Required for text positioning on the title page
\usepackage{scrextend}

%% Render title page. Old option, \maketitle should
%% be used directly (this is just a wrapper around \maketitle)
\newcommand{\rendertitlepage}[0]{\maketitle}

%% Allows to use beamer default \maketitle
\defbeamertemplate*{title page}{customized}[1][]
{
      \begin{tikzpicture}[remember picture,overlay,anchor=north west,inner sep=0pt]

         \node[xshift=7.5mm,yshift=-6mm] at (current page.north west) {
            % Ignore title page logo on all title slides which are not slide 1
            \ifnum\theframenumber=1
               \includegraphics[width=70mm]{\mylogoimage}%
            \fi
         };

         %% License
         \iflicense
            \node[xshift=-14.99mm,yshift=4.35mm] at (current page.south east) {
               \includegraphics[width=5mm]{license_ccby}
            };
         \fi

         % Shows the R/exams title image. Always include image the same way,
	      % i.e., for 4:3 the image extends outside the page.
         \IfStrEqCase{\myheaderimageposition}{
            {ne}{%
               \node[xshift=-161mm,yshift=-23.6mm] at (current page.north east) {%
                  \includegraphics[width=162mm]{\myheaderimage}%
               };%
            }{nw}{
               \node[xshift=-1mm,yshift=-23.6mm] at (current page.north west) {%
                  \includegraphics[width=162mm]{\myheaderimage}%
               };%
            }}
      \end{tikzpicture}

      %% Title/subtitle, author, URL
      \vspace*{5.1cm}
      {%
         \usebeamercolor[fg]{title}%
	      \usebeamerfont{title}%
         \inserttitle%
      }%
	  
      {%
         \usebeamercolor[fg]{subtitle}%
	      \usebeamerfont{subtitle}%
         \insertsubtitle%
	      \medskip%
      }%

      \bigskip

      {%
         \usebeamercolor[fg]{author}%
         \usebeamerfont{author}%
         \insertauthor%
      }%

      \medskip

      {%
	 \href{\myURL}{\tt \usebeamercolor[fg]{url} \myURL}%
      }%

    \addtocounter{framenumber}{-1}
    % reset background image
    \usebackgroundtemplate{}
}

\ifnosectiontitlepage
    % do nothing here, create the titlepage via \titlepage in the presentation
\else
   \AtBeginSection[]{
      {\setbeamertemplate{footline}{}
         \ifnosectiontitlepage
         \else
            \rendertitlepage{}
         \fi
      }
   }
\fi


%empty page with only name of subsection at start of each subsection - for long talks where the structure helps
\ifsectionintroframe
    \AtBeginSection[]{
        \usebackgroundtemplate{\includegraphics[width=\paperwidth,height=\paperheight]{titlebackground.pdf}}
        {\setbeamertemplate{footline}{}
        \begin{frame}
            \vspace*{3.5cm}
            \begin{center}
            \vspace{0pt}
            \usebeamercolor[fg]{title}
            \iftitleoutline
                {\fontsize{20}{24} \bfseries\selectfont\textoutline{\thesection.~\insertsection} \par}
            \else
                {\fontsize{20}{24} \bfseries\selectfont\thesection.~\insertsection \par}
            \fi
            \end{center}
        \end{frame}}
        \addtocounter{framenumber}{-1}
        \usebackgroundtemplate{}
    }
\else
\fi

%% Table of Contents - Setup
\setbeamertemplate{section in toc}{ \hspace*{0.5cm}%
                                    \LARGE%
                                    \inserttocsectionnumber.~\inserttocsection}
\setbeamertemplate{subsection in toc}{}
\setbeamertemplate{subsubsection in toc}{}
\setbeamertemplate{subsubsubsection in toc}{}



\setbeamercolor*{subsectionfade}{use={normal text},parent={normal text},fg=structure.fg!30!normal text.bg}

%hyperref settings
% etoolbox is required because beamer usually sets those options itsself,
% but we want to override them; (default beamer has full title and subtitle
% as pdftitle)
% this is also the reason why we need 'usepdftitle=false' in the documentclass options,
% it disables beamer's pdfinfo settings
\RequirePackage{etoolbox}
\makeatletter
\AtEndPreamble{
  \hypersetup{
    colorlinks = true,
    urlcolor = rexamsdgreen,
    pdfauthor = {\beamer@shortauthor},
    pdfsubject = {{\inserttitle} - {\insertsubtitle}},
    pdftitle = {\beamer@shorttitle},
    bookmarksopen=false,
    pdfstartview=Fit
  }
}
\makeatother

%% additional commands
%% text
\newcommand{\squote}[1]{`{#1}'}
\newcommand{\dquote}[1]{``{#1}''}
%% programming
\makeatletter
\newcommand\code{\bgroup\@makeother\_\@makeother\~\@makeother\$\@codex}
\def\@codex#1{{\normalfont\ttfamily\hyphenchar\font=-1\usebeamercolor[fg]{code} #1}\egroup}
\makeatother
\let\proglang=\textsf
\newcommand{\dataset}[1]{{\usebeamercolor[fg]{verbcolor}{\texttt{#1}}}}
\newcommand{\file}[1]{{\usebeamercolor[fg]{verbcolor}{\texttt{#1}}}}
\newcommand{\fct}[1]{\texttt{#1()}}
\newcommand{\class}[1]{\dquote{\texttt{#1}}}
\newcommand{\pkg}[1]{{\emph{#1}}}
\newcommand{\email}[1]{\href{mailto:#1}{{\usebeamercolor[fg]{verbcolor}\normalfont\texttt{#1}}}}
\newcommand{\doi}[1]{\href{http://dx.doi.org/#1}{{\usebeamercolor[fg]{verbcolor}\normalfont\texttt{doi:#1}}}}
%% mathematics
\newcommand{\E}{\textnormal{E}}
\newcommand{\Var}{\textnormal{Var}}
\newcommand{\Cov}{\textnormal{Cov}}
\newcommand{\Cor}{\textnormal{Cor}}
\newcommand{\Prob}{\textnormal{Pr}}
%% customization
\newcommand{\footertext}[1]{\gdef\myfootertext{#1}}
\newcommand{\URL}[1]{\gdef\myURL{#1}}

%variable width block, centered, use as \begin{varblock}[WIDTH]{blockheader text}...\end{varblock}
\newenvironment<>{varblock}[2][\textwidth]{%
    \begin{center}%
      \begin{minipage}{#1}%
        \setlength{\textwidth}{#1}%
          \begin{actionenv}#3%
            \def\insertblocktitle{#2}%
            \par%
            \usebeamertemplate{block begin}}
  {\par%
      \usebeamertemplate{block end}%
    \end{actionenv}
  \end{minipage}%
\end{center}}

%this avoids slides in the appendix from being counted as framenumber (bottom right)
%copied from appendixnumberbeamer.sty
\makeatletter
\let\appendixtotalframenumber\empty
\def\mainend{-1}
\let\appendixorig\appendix
% Redefine the \appendix command:
%   - it resets the framenumber counter
%   - freezes the total framenumber for this first part of the document
\def\appendix{
  \edef\mainend{\theframenumber}
  \immediate\write\@auxout{\string\global\string\@namedef{mainendframenumber}{\mainend}}
  \appendixorig
  \def\inserttotalframenumber{\appendixtotalframenumber}%
  \setcounter{framenumber}{0}
}
% To be called at the end of document to fix the total framenumber in the
% main document and in the appendix.
\def\pageatend{
  \edef\appendixend{\theframenumber}
  \ifnum\mainend>0%
  \immediate\write\@auxout{\string\global\string\@namedef{appendixtotalframenumber}{\appendixend}}%
  \immediate\write\@auxout{\string\global\string\@namedef{inserttotalframenumber}{\mainend}}%
  \immediate\write\@auxout{\string\@writefile{nav}{\noexpand \headcommand {%
        \noexpand \def\noexpand \inserttotalframenumber{\mainend}}}}%
  \immediate\write\@auxout{\string\@writefile{nav}{\noexpand \headcommand {%
        \noexpand \def\noexpand \appendixtotalframenumber{\appendixend}}}}%
  \else
  \fi
}
\AtEndDocument{\pageatend}
\makeatother

%% defaults
\headerimage{1}
\logoimage{rexams_logo}
\footerlogoimage{rexams_logo}
\URL{http://www.R-exams.org/}
\footertext{}
\date{}

